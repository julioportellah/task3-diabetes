---

title: "Untitled"
author: "Julio Portella"
date: "6/3/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```
## Importing R libraries

Importing the libraries

```{r cars}
library(dplyr)
library(caret)
library(Boruta)
library(randomForest)
library(glmnet)
library(randomForestExplainer)
library(rfFC)
library(ROCR)
library(precrec)
library(precrec)
library(ROSE)
library(ALEPlot)
```

## Loading the data

Load the data 
```{r}
library(dplyr)
source_data <- read.csv("D:/Globant/Task3/data/diabetic_data_processed_bin.csv", header=TRUE, sep=",")
sample_size = floor(0.8*nrow(source_data))
set.seed(2345)
picked = sample(seq_len(nrow(source_data)),size = sample_size)
train_data =source_data[picked,]
test_data =source_data[-picked,]
#source_CPET <-source_CPET %>% select(-c(X, PatientId,SessionId , sex, age,BMI,HasAnaerobicThresholdMean))
```


```{r}
#selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(train_data$NoReadmission) ~ as.factor(train_data$race) + train_data$time_in_hospital+ as.factor(train_data$gender)+ as.factor(train_data$TypeCondition)+as.factor(train_data$A1Cresult_bin)+ as.factor(train_data$age), data=train_data,  ntree=500, mtry=2, importance=TRUE, keep.inbag=TRUE,classwt=c(1,1.5),replace=TRUE)
print(main_rf_classifier)
#prediction_for_table<-predict(main_rf_classifier,test_data)
#table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

```{r}
#selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(readmitted) ~ as.factor(train_data$race) + train_data$time_in_hospital+ as.factor(train_data$gender)+ as.factor(train_data$TypeCondition)+as.factor(train_data$A1Cresult_bin)+ as.factor(train_data$age), data=train_data,  ntree=500, mtry=2, importance=TRUE, keep.inbag=TRUE,classwt=c(35,20,10),replace=TRUE)
print(main_rf_classifier)
#prediction_for_table<-predict(main_rf_classifier,test_data)
#table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

```{r}
#selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(readmitted) ~ as.factor(train_data$race) + train_data$time_in_hospital+ as.factor(train_data$gender)+ as.factor(train_data$TypeCondition)+as.factor(train_data$A1Cresult_bin)+ as.factor(train_data$age), data=train_data,  ntree=500, mtry=2, importance=TRUE, keep.inbag=TRUE,classwt=c(35,20,10),replace=TRUE)
print(main_rf_classifier)
#prediction_for_table<-predict(main_rf_classifier,test_data)
#table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

Finding more data
Scaling the data
```{r}
#dat2 <- source_CPET %>% mutate_at(-c("CardiacLim ", "PulmonaryLim","MuscleSkeletalLim"), ~(scale(.) %>% as.vector))
dat2 <- source_CPET %>% mutate_at(c("MaxVO2_EST","PredictedMaxHR",
"PeakHeartRate","MeanHeartRate","MinHeartRate","StdHeartRate","LowestVE.VCO2",
"PeakVE.VCO2","MeanVE.VCO2","StdVE.VCO2","PeakVO2Real","DiffPeakVO2",
"DiffPeakHR","DiffPercentPeakVO2","DiffPercentPeakHR","DiffPeakRER","MeanRER",
"PeakRER","LowestRER","MeanVE","PeakVE","LowestVE",
"MeanRR","PeakRR","LowestRR","MeanVO2","PeakVO2",
"LowestVO2","MeanVCO2","PeakVCO2","LowestVCO2","HRvsVO2Slope",
"VEvsVCO2Slope","MeanO2Pulse","MaxO2Pulse","MinO2Pulse","StdO2Pulse",
"MaxO2_EST","O2PulseDiff","O2PulsePercent","X75_to_100_VO2Slope","X75_to_100_HRSlope",
"X75_to_100_VCO2Slope","X75_to_100_VESlope","X75_to_100_RERSlope","X75_to_100_RRSlope","X75_to_100_O2Slope",
"X75_to_100_VEVCO2Slope","X75_to_100_VEVO2Slope","X50_to_75_VO2Slope","X50_to_75_HRSlope","X50_to_75_VCO2Slope",
"X50_to_75_VESlope","X50_to_75_RERSlope","X50_to_75_RRSlope","X50_to_75_O2Slope","X50_to_75_VEVCO2Slope",
"X50_to_75_VEVO2Slope","X25_to_50_VO2Slope","X25_to_50_HRSlope","X25_to_50_VCO2Slope","X25_to_50_VESlope",
"X25_to_50_RERSlope","X25_to_50_RRSlope","X25_to_50_O2Slope","X25_to_50_VEVCO2Slope","X25_to_50_VEVO2Slope",
"X0_to_25_VO2Slope","X0_to_25_HRSlope","X0_to_25_VCO2Slope","X0_to_25_VESlope","X0_to_25_RERSlope",
"X0_to_25_RRSlope","X0_to_25_O2Slope","X0_to_25_VEVCO2Slope","X0_to_25_VEVO2Slope","X15_to_85_VO2Slope",
"X15_to_85_HRSlope","X15_to_85_VCO2Slope","X15_to_85_VESlope","X15_to_85_RERSlope","X15_to_85_RRSlope",
"X15_to_85_O2Slope","X15_to_85_VEVCO2Slope","X15_to_85_VEVO2Slope","VTTime","VO2atVT",
"PercentTimeAfterVT","VO2vsPeakVO2atVT"), ~(scale(.) %>% as.vector))
```
Selecting the cardiac limitation data with the random split
```{r}
cardiac_lim_data <-dat2 %>% select(-c(PulmonaryLim,MuscleSkeletalLim,Healthy))
sample_size = floor(0.8*nrow(cardiac_lim_data))
set.seed(2345)
picked = sample(seq_len(nrow(cardiac_lim_data)),size = sample_size)
train_data =cardiac_lim_data[picked,]
test_data =cardiac_lim_data[-picked,]
```

Using boruta for feature selection FOR THE CARDIAC LIMITATION
```{r}
boruta.train <- Boruta(CardiacLim~., data = cardiac_lim_data, doTrace = 2)
```

```{r}
boruta.train
```


```{r}
plot(boruta.train, xlab = "", xaxt = "n", type='l')
lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i)
boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
names(lz) <- colnames(boruta.train$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train$ImpHistory), cex.axis = 0.5)
#text(cex = 0.9)
#text(x = 1:length(boruta.train), y = par("usr")[3] - 2.5, labels = names(Labels), srt = 35, cex = 0.8, xpd = NA)
```
Picking only the confirmed
```{r}
boruta.df.chosen <- attStats(boruta.train)
boruta.df.chosen %>% filter(decision == 'Confirmed') %>% arrange(desc(meanImp))
```

Picking tentative features into important features
```{r}
final.boruta <- TentativeRoughFix(boruta.train)
print(final.boruta)
getSelectedAttributes(final.boruta, withTentative = F)
```


```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))
boruta.chosen <- boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))
```

now that we have the selected features, let's use random forest
```{r}
#train_data =cardiac_lim_data[picked,]
#test_data =cardiac_lim_data[-picked,]
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
#main_rf_classifier = randomForest(as.factor(CardiacLim) ~ MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=FALSE)

#main_rf_classifier = randomForest(as.factor(CardiacLim) ~ DiffPercentPeakVO2+X75_to_100_VO2Slope+X75_to_100_HRSlope+DiffPeakVO2+X75_to_100_VCO2Slope+MeanVE.VCO2+X75_to_100_VESlope+O2PulseDiff
#+O2PulsePercent+X15_to_85_RRSlope+X75_to_100_RERSlope+MinO2Pulse+X25_to_50_VCO2Slope+MeanHeartRate+X75_to_100_O2Slope+X50_to_75_O2Slope
#+LowestVE.VCO2+X15_to_85_VEVCO2Slope+X25_to_50_VO2Slope+X75_to_100_RRSlope+StdVE.VCO2+MeanRER+PeakVO2Real+LowestVO2+LowestRR+PeakRR	
#,data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,10), keep.inbag=TRUE,replace=FALSE)
main_rf_classifier = randomForest(as.factor(CardiacLim) ~ DiffPercentPeakVO2+X75_to_100_VO2Slope+X75_to_100_HRSlope+DiffPeakVO2 +X75_to_100_VCO2Slope+X75_to_100_VESlope+MeanVE.VCO2+O2PulseDiff+X15_to_85_RRSlope+O2PulsePercent+X75_to_100_RERSlope +MinO2Pulse+X25_to_50_VESlope+X25_to_50_VCO2Slope+MeanHeartRate+X75_to_100_RRSlope+X75_to_100_VEVCO2Slope
,data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(sum(train_data$CardiacLim),length(train_data$CardiacLim)-sum(train_data$CardiacLim)), keep.inbag=TRUE,replace=TRUE)
print(main_rf_classifier)
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

```{r}
predictors <- c('DiffPercentPeakVO2','X75_to_100_VO2Slope','X75_to_100_HRSlope','DiffPeakVO2','X75_to_100_VCO2Slope',
                'X75_to_100_VESlope','MeanVE.VCO2','O2PulseDiff','X15_to_85_RRSlope','O2PulsePercent','X75_to_100_RERSlope',
                'MinO2Pulse','X25_to_50_VESlope','X25_to_50_VCO2Slope','MeanHeartRate','X75_to_100_RRSlope','X75_to_100_VEVCO2Slope')
#yhat<-function(main_rf_classifier, newdata)as.numeric(predict(main_rf_classifier,newdata))
yhat <- function(X.model, newdata) as.numeric(predict(X.model, newdata))
#ALE.1=ALEPlot(train_data[-4], main_rf_classifier, pred.fun=yhat, J=15, K=15, NA.plot = FALSE)
#ALE.1=ALEPlot(train_data[-4], main_rf_classifier, pred.fun=yhat, J=1, K=1, NA.plot = FALSE)
#ALE.1=ALEPlot(train_data[-4], main_rf_classifier, pred.fun=yhat, J=2, K=18, NA.plot = FALSE)
#ALE.2=ALEPlot(DAT[,2:4], lm.DAT, pred.fun=yhat, J=2, K=50, NA.plot = TRUE)
for(i in 1:length(train_data[-4])){
    ALEPlot(train_data[-4], main_rf_classifier, pred.fun=yhat, J=i, K=i, NA.plot = FALSE)
    #print(col.names(train_data[i]))
    #if (any(predictors==colnames(train_data)[i])){
    #    print(colnames(train_data)[i])
    #    ALE.1=ALEPlot(train_data[-4], main_rf_classifier, pred.fun=yhat, J=i, K=i, NA.plot = TRUE)
    #}
    #ALE.1=ALEPlot(train_data[-4], main_rf_classifier, pred.fun=yhat, J=i, K=i, NA.plot = TRUE)
}
```

Keeping the values witha score over 3
```{r}
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(CardiacLim) ~ 
                                      DiffPercentPeakVO2+X75_to_100_VO2Slope+X75_to_100_HRSlope+DiffPeakVO2+X75_to_100_VCO2Slope+MeanVE.VCO2+X75_to_100_VESlope+O2PulseDiff
+O2PulsePercent+X15_to_85_RRSlope+X75_to_100_RERSlope+MinO2Pulse+X25_to_50_VCO2Slope+MeanHeartRate+X75_to_100_O2Slope+X50_to_75_O2Slope
+LowestVE.VCO2+X15_to_85_VEVCO2Slope+X25_to_50_VO2Slope+X75_to_100_RRSlope+StdVE.VCO2+MeanRER+PeakVO2Real+LowestVO2+LowestRR+PeakRR	
, data=train_data,  ntree=500, mtry=2, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=TRUE)
print(main_rf_classifier)
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```
Keeping the values witha score over 4
```{r}
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(CardiacLim) ~ 
 DiffPercentPeakVO2+X75_to_100_VO2Slope+X75_to_100_HRSlope+DiffPeakVO2+X75_to_100_VCO2Slope+MeanVE.VCO2+X75_to_100_VESlope+O2PulseDiff
+O2PulsePercent+X15_to_85_RRSlope+X75_to_100_RERSlope+MinO2Pulse+X25_to_50_VCO2Slope+MeanHeartRate+X75_to_100_O2Slope+X50_to_75_O2Slope
+LowestVE.VCO2+X15_to_85_VEVCO2Slope+X25_to_50_VO2Slope+X75_to_100_RRSlope+StdVE.VCO2+MeanRER+PeakVO2Real+LowestVO2+LowestRR+PeakRR	
, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,10), keep.inbag=TRUE,replace=FALSE)
print(main_rf_classifier)
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```
Keeping the values witha score over 5
```{r}
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(CardiacLim) ~ X75_to_100_VO2Slope+DiffPeakVO2+X75_to_100_HRSlope+StdVE.VCO2		, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,10), keep.inbag=TRUE,replace=FALSE)
print(main_rf_classifier)
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

```{r}
#train_data =cardiac_lim_data[picked,]
#test_data =cardiac_lim_data[-picked,]
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
#main_rf_classifier = randomForest(as.factor(CardiacLim) ~ MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=FALSE)
#main_rf_classifier = randomForest(as.factor(CardiacLim) ~ X75_to_100_VO2Slope+X75_to_100_HRSlope+DiffPeakVO2+X75_to_100_VCO2Slope + X75_to_100_VESlope + MeanVE.VCO2	+ MeanVO2+ StdO2Pulse+ X75_to_100_RRSlope+ MeanHeartRate +X75_to_100_O2Slope+ StdVE.VCO2+ PeakVO2Real+MeanVCO2+X15_to_85_VEVCO2Slope	, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,1000), keep.inbag=TRUE,replace=FALSE)
main_rf_classifier = randomForest(as.factor(CardiacLim) ~ X75_to_100_VO2Slope+DiffPeakVO2+X75_to_100_HRSlope+StdVE.VCO2	 + X15_to_85_RRSlope + PeakVE	+ MeanHeartRate+ X75_to_100_RERSlope+ MeanRER+ HRvsVO2Slope +X75_to_100_VEVCO2Slope+ PeakVCO2+ PredictedMaxHR+X75_to_100_VCO2Slope+MeanVE+X75_to_100_VESlope+PeakVO2Real+LowestVE.VCO2	+VO2atVT+PeakHeartRate	, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,10), keep.inbag=TRUE,replace=FALSE)
print(main_rf_classifier)
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

On the test dataset
```{r}
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```
On the test dataset
```{r}
prediction_for_table<-predict(main_rf_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```
Looks promising

```{r}
prediction_for_roc_curve <- predict(main_rf_classifier,test_data,type="prob")
pretty_colours <- c("#F8766D","#00BA38","#619CFF")
# Specify the different classes 
classes <- levels(test_data$CardiacLim)
true_values <- ifelse(test_data$CardiacLim,1,0)

pred <- prediction(prediction_for_roc_curve[,2], test_data$CardiacLim)
perf <- performance(pred,"tpr","fpr")
plot(perf)

pred <- prediction(prediction_for_roc_curve,true_values)
plot(prediction_for_roc_curve,main="ROC Curve")
```


```{r}
library(precrec)
precrec_obj <- evalmod(scores = prediction_for_roc_curve[,2], labels = test_data$CardiacLim)
autoplot(precrec_obj)
```


```{r}
library(precrec)
precrec_obj <- evalmod(scores = prediction_for_roc_curve[,2], labels = test_data$CardiacLim)
autoplot(precrec_obj)
library(PRROC)

PRROC_obj <- roc.curve(scores.class0 = prediction_for_roc_curve[,2], weights.class0=test_data$CardiacLim,
                       curve=TRUE)
plot(PRROC_obj)

```
On the test dataset
```{r}
prediction_for_table<-predict(main_rf_classifier,test_data)
table.conf <- table(observed=test_data$CardiacLim,predicted=prediction_for_table)
print('Positive Predictive Value')
print(table.conf[2,2]/(table.conf[2,2]+table.conf[1,2]))
print('Sensitivity')
print(table.conf[2,2]/(table.conf[2,2]+table.conf[2,1]))
print('Specificity')
print(table.conf[1,1]/(table.conf[1,1]+table.conf[1,2]))
print('Accuracy')
print((table.conf[1,1]+table.conf[2,2])/(table.conf[1,1]+table.conf[1,2]+table.conf[2,2]+table.conf[2,1]))

```

Variable importance
```{r}
varImpPlot(main_rf_classifier)
```
K-Fold cross validation


```{r cars}
#Randomly shuffle the data
cardiac_lim_data_cross <- cardiac_lim_data
cardiac_lim_data_cross<-cardiac_lim_data_cross[sample(nrow(cardiac_lim_data_cross)),]
#cardiac_lim_data_cross <- cardiac_lim_data
#cardiac_lim_data_cross<-cardiac_lim_data_cross[sample(nrow(cardiac_lim_data_cross)),]
#cardiac_lim_data_cross <- data_balanced_over
#cardiac_lim_data_cross <- data_balanced_over[sample(nrow(data_balanced_over)),]

#Create 10 equally size folds
folds <- cut(seq(1,nrow(cardiac_lim_data_cross)),breaks=5,labels=FALSE)
positive.predictive.value <- rep()
sensitivity.val <- rep()
specificity.val <- rep()
accuracy.val <- rep()
roc.vals <- rep()
#Perform 10 fold cross validation
for(i in 1:5){
    #Segement your data by fold using the which() function 
    testIndexes <- which(folds==i,arr.ind=TRUE)
    testData <- cardiac_lim_data_cross[testIndexes, ]
    trainData <- cardiac_lim_data_cross[-testIndexes, ]
    rf_classifier = randomForest(as.factor(CardiacLim) ~DiffPercentPeakVO2+X75_to_100_VO2Slope+X75_to_100_HRSlope+DiffPeakVO2 +X75_to_100_VCO2Slope+X75_to_100_VESlope+MeanVE.VCO2+O2PulseDiff+X15_to_85_RRSlope+O2PulsePercent+X75_to_100_RERSlope +MinO2Pulse+X25_to_50_VESlope+X25_to_50_VCO2Slope+MeanHeartRate+X75_to_100_RRSlope+X75_to_100_VEVCO2Slope
                                     , data=trainData,  ntree=500, mtry=2, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=TRUE)
    #rf_classifier = randomForest(as.factor(CardiacLim) ~ X75_to_100_VO2Slope+DiffPeakVO2+X75_to_100_HRSlope+StdVE.VCO2	 + X15_to_85_RRSlope + PeakVE	+ MeanHeartRate+ X75_to_100_RERSlope+ MeanRER+ HRvsVO2Slope +X75_to_100_VEVCO2Slope+ PeakVCO2+ PredictedMaxHR+X75_to_100_VCO2Slope+MeanVE+X75_to_100_VESlope+PeakVO2Real+LowestVE.VCO2	+VO2atVT+PeakHeartRate, data=trainData, ntree=500, mtry=2, importance=TRUE,classwt=c(20,10), keep.inbag=TRUE,replace=FALSE)
    
    prediction_for_table<-predict(rf_classifier,testData)
    table.conf <- table(observed=testData$CardiacLim,predicted=prediction_for_table)
    print(table.conf)
    ppv <-table.conf[2,2]/(table.conf[2,2]+table.conf[1,2])
    stvt <-table.conf[2,2]/(table.conf[2,2]+table.conf[2,1])
    spcft <-table.conf[1,1]/(table.conf[1,1]+table.conf[1,2])
    accrcy <- (table.conf[1,1]+table.conf[2,2])/(table.conf[1,1]+table.conf[1,2]+table.conf[2,2]+table.conf[2,1])
    positive.predictive.value <- append(positive.predictive.value, ppv)
    sensitivity.val <- append(sensitivity.val,stvt)
    specificity.val <- append(specificity.val,spcft)
    accuracy.val <- append(accuracy.val,accrcy)
    prediction_for_roc_curve <- predict(rf_classifier,testData,type="prob")
    PRROC_obj <- PRROC::roc.curve(scores.class0 = prediction_for_roc_curve[,2], weights.class0=testData$CardiacLim,
                       curve=TRUE)
    roc.vals <- append(roc.vals, PRROC_obj$auc)
}
print('Positive Predictive Value')
print(mean(positive.predictive.value))
print(sd(positive.predictive.value))
print('Sensitivity')
print(mean(sensitivity.val))
print(sd(sensitivity.val))
print('Specificity')
print(mean(specificity.val))
print(sd(specificity.val))
print('Accuracy')
print(mean(accuracy.val))
print(sd(accuracy.val))
print('AUC')
print(mean(roc.vals))
print(sd(roc.vals))
```


```{r cars}
#Randomly shuffle the data
cardiac_lim_data_cross <- cardiac_lim_data
cardiac_lim_data_cross<-cardiac_lim_data_cross[sample(nrow(cardiac_lim_data_cross)),]
#cardiac_lim_data_cross <- cardiac_lim_data
#cardiac_lim_data_cross<-cardiac_lim_data_cross[sample(nrow(cardiac_lim_data_cross)),]
#cardiac_lim_data_cross <- data_balanced_over
#cardiac_lim_data_cross <- data_balanced_over[sample(nrow(data_balanced_over)),]

#Create 10 equally size folds
folds <- cut(seq(1,nrow(cardiac_lim_data_cross)),breaks=5,labels=FALSE)
positive.predictive.value <- rep()
sensitivity.val <- rep()
specificity.val <- rep()
accuracy.val <- rep()
roc.vals <- rep()
#Perform 10 fold cross validation
for(i in 1:5){
    #Segement your data by fold using the which() function 
    testIndexes <- which(folds==i,arr.ind=TRUE)
    testData <- cardiac_lim_data_cross[testIndexes, ]
    trainData <- cardiac_lim_data_cross[-testIndexes, ]
    rf_classifier = randomForest(as.factor(CardiacLim) ~ X75_to_100_VO2Slope+DiffPeakVO2+X75_to_100_HRSlope+X75_to_100_VCO2Slope	 + X75_to_100_VESlope + MeanVO2	+ X75_to_100_O2Slope+ X75_to_100_RRSlope+ MeanVE.VCO2 + MinO2Pulse +PeakVO2+ StdO2Pulse+ VO2atVT+LowestRER, data=trainData, ntree=500, mtry=2, importance=TRUE,classwt=c(20,10), keep.inbag=TRUE,replace=FALSE)
    #rf_classifier = randomForest(as.factor(CardiacLim) ~ MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope, data=trainData, ntree=500, mtry=10, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=FALSE)
    prediction_for_table<-predict(rf_classifier,testData)
    table.conf <- table(observed=testData$CardiacLim,predicted=prediction_for_table)
    print(table.conf)
    ppv <-table.conf[2,2]/(table.conf[2,2]+table.conf[1,2])
    stvt <-table.conf[2,2]/(table.conf[2,2]+table.conf[2,1])
    spcft <-table.conf[1,1]/(table.conf[1,1]+table.conf[1,2])
    accrcy <- (table.conf[1,1]+table.conf[2,2])/(table.conf[1,1]+table.conf[1,2]+table.conf[2,2]+table.conf[2,1])
    positive.predictive.value <- append(positive.predictive.value, ppv)
    sensitivity.val <- append(sensitivity.val,stvt)
    specificity.val <- append(specificity.val,spcft)
    accuracy.val <- append(accuracy.val,accrcy)
    prediction_for_roc_curve <- predict(rf_classifier,testData,type="prob")
    PRROC_obj <- PRROC::roc.curve(scores.class0 = prediction_for_roc_curve[,2], weights.class0=testData$CardiacLim,
                       curve=TRUE)
    roc.vals <- append(roc.vals, PRROC_obj$auc)
}
print('Positive Predictive Value')
print(mean(positive.predictive.value))
print(sd(positive.predictive.value))
print('Sensitivity')
print(mean(sensitivity.val))
print(sd(sensitivity.val))
print('Specificity')
print(mean(specificity.val))
print(sd(specificity.val))
print('Accuracy')
print(mean(accuracy.val))
print(sd(accuracy.val))
print('AUC')
print(mean(roc.vals))
print(sd(roc.vals))
```


Doing SVM for benchmarking
```{r}
#train_data =cardiac_lim_data[picked,]
#test_data =cardiac_lim_data[-picked,]
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
#main_rf_classifier = randomForest(as.factor(CardiacLim) ~ MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope, data=train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=FALSE)
library(e1071)

main_svm_classifier <- svm(as.factor(CardiacLim) ~ MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope, data=train_data, class.weights=c("0"=1,"1"=1))
print(main_svm_classifier)
```

On the test dataset
```{r}
prediction_for_table<-predict(main_svm_classifier,test_data)
table(observed=test_data$CardiacLim,predicted=prediction_for_table)
```

Testing the logistic regression
```{r}
#explain_forest(rf_classifier, interactions = TRUE, data = trainData)
li<-getLocalIncrements(main_rf_classifier, train_data)
fc<-featureContributions(main_rf_classifier, li, train_data)
boxplot(as.data.frame(fc), las=2)
#, horizontal=T
#library(ggplot2)
# Basic box plot
#bp <- ggplot(as.data.frame(fc), aes(x=group, y=weight))+
#  geom_boxplot()
#bp
# Horizontal box plot
#bp + coord_flip()

```
Testing the logistic regression
```{r}
#explain_forest(rf_classifier, interactions = TRUE, data = trainData)
li<-getLocalIncrements(main_rf_classifier, train_data)
fc<-featureContributions(main_rf_classifier, li, test_data)
boxplot(as.data.frame(fc), las=2)
```


Balancing the data
```{r}
library(ROSE)
data_balanced_over <- ovun.sample(CardiacLim ~ ., data = cardiac_lim_data, method = "over", N = 310, seed = 1)$data
data_balanced_under <- ovun.sample(CardiacLim ~ ., data = cardiac_lim_data, method = "under", N = 80, seed = 1)$data
table(data_balanced_over$CardiacLim)
table(pulmonary_train_data$CardiacLim)
X_train_card_a <- as.matrix(data_balanced_over[-2])
y_train_card_a <- as.factor(data_balanced_over$CardiacLim)
boruta.train.balanced <- Boruta(CardiacLim~., data = data_balanced_over, doTrace = 2)
plot(boruta.train.balanced, xlab = "", xaxt = "n")
lz<-lapply(1:ncol(boruta.train.balanced$ImpHistory),function(i)
boruta.train.balanced$ImpHistory[is.finite(boruta.train.balanced$ImpHistory[,i]),i])
names(lz) <- colnames(boruta.train.balanced$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train.balanced$ImpHistory), cex.axis = 0.7)

```



## Pulmonary Limitation Model


Selecting the pulmonary limitation data with the random split
```{r}
pulmonary_lim_data <-dat2 %>% select(-c(CardiacLim,MuscleSkeletalLim,Healthy))
sample_size = floor(0.8*nrow(pulmonary_lim_data))
set.seed(2345)
picked = sample(seq_len(nrow(pulmonary_lim_data)),size = sample_size)
pulm_train_data =pulmonary_lim_data[picked,]
pulm_test_data =pulmonary_lim_data[-picked,]
```

Using boruta for feature selection FOR THE PULMONARY LIMITATION
```{r}
boruta.train <- Boruta(as.factor(PulmonaryLim)~., data = pulmonary_lim_data, doTrace = 2)
```

```{r}
plot(boruta.train, xlab = "", xaxt = "n")
lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i)
boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
names(lz) <- colnames(boruta.train$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train$ImpHistory), cex.axis = 0.5)
```

```{r}
boruta.df <- attStats(boruta.train)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```
Picking tentative features into important features
```{r}
final.boruta <- TentativeRoughFix(boruta.train)
print(final.boruta)
getSelectedAttributes(final.boruta, withTentative = F)
```


```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```


On the test dataset
```{r}
#pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ MeanHeartRate+MeanVE.VCO2+DiffPeakVO2+PeakVE+MeanVO2+VEvsVCO2Slope+MeanO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75O2Slope+MeanVCO2, data=pulm_train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,1000),keep.inbag=TRUE,replace=FALSE)
pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ X75_to_100_VCO2Slope+X75_to_100_VO2Slope+VEvsVCO2Slope+MeanVE.VCO2	+X75_to_100_VESlope+X75_to_100_O2Slope+X75_to_100_HRSlope+MeanHeartRate+DiffPeakVO2+X75_to_100_RRSlope+X15_to_85_VEVO2Slope+MeanVO2+LowestVE+PeakHeartRate+MeanO2Pulse, data=pulm_train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,1000),keep.inbag=TRUE,replace=FALSE)
prediction_for_table<-predict(pulm_rf_classifier,pulm_test_data)
table(observed=pulm_test_data$PulmonaryLim,predicted=prediction_for_table)
```

Picking tentative features into important features
```{r}
final.boruta <- TentativeRoughFix(boruta.train)
print(final.boruta)
getSelectedAttributes(final.boruta, withTentative = F)
```


```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```

On the test dataset
```{r}
#pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ MeanHeartRate+MeanVE.VCO2+DiffPeakVO2+PeakVE+MeanVO2+VEvsVCO2Slope+MeanO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75O2Slope+MeanVCO2, data=pulm_train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,1000),keep.inbag=TRUE,replace=FALSE)
pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ X75_to_100_VCO2Slope+X75_to_100_VO2Slope+VEvsVCO2Slope+MeanVE.VCO2	+X75_to_100_VESlope+X75_to_100_O2Slope+X75_to_100_HRSlope+DiffPeakVO2+X75_to_100_RRSlope+LowestVE, data=pulm_train_data, ntree=500, mtry=3, importance=TRUE,classwt=c(1111,202),keep.inbag=TRUE,replace=FALSE)
#pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ ., data=pulm_train_data, ntree=500, mtry=3, importance=TRUE,classwt=c(1000,20),keep.inbag=TRUE,replace=FALSE)
prediction_for_table<-predict(pulm_rf_classifier,pulm_test_data)
table(observed=pulm_test_data$PulmonaryLim,predicted=prediction_for_table)
```

On the test dataset
```{r}
#pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ MeanHeartRate+MeanVE.VCO2+DiffPeakVO2+PeakVE+MeanVO2+VEvsVCO2Slope+MeanO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75O2Slope+MeanVCO2, data=pulm_train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(20,1000),keep.inbag=TRUE,replace=FALSE)
pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ X75_to_100_VCO2Slope+X75_to_100_VO2Slope+VEvsVCO2Slope+MeanVE.VCO2	+X15_to_85_VESlope+MeanO2Pulse+PredictedMaxHR+MaxVO2_EST+DiffPeakHR+X75_to_100_VEVCO2Slope+StdVE.VCO2+X15_to_85_VEVCO2Slope		, data=pulm_train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(1500,240),keep.inbag=TRUE,replace=FALSE)
#pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~ ., data=pulm_train_data, ntree=500, mtry=3, importance=TRUE,classwt=c(1000,20),keep.inbag=TRUE,replace=FALSE)
prediction_for_table<-predict(pulm_rf_classifier,pulm_test_data)
table(observed=pulm_test_data$PulmonaryLim,predicted=prediction_for_table)
```
```{r cars}
#Randomly shuffle the data
pulmonary_lim_data_cross <- pulmonary_lim_data
pulmonary_lim_data_cross<-pulmonary_lim_data_cross[sample(nrow(pulmonary_lim_data_cross)),]

#Create 10 equally size folds
folds <- cut(seq(1,nrow(pulmonary_lim_data_cross)),breaks=5,labels=FALSE)
positive.predictive.value <- rep()
sensitivity.val <- rep()
specificity.val <- rep()
accuracy.val <- rep()
roc.vals <- rep()
#Perform 10 fold cross validation
for(i in 1:5){
    #Segement your data by fold using the which() function 
    testIndexes <- which(folds==i,arr.ind=TRUE)
    testData <- pulmonary_lim_data_cross[testIndexes, ]
    trainData <- pulmonary_lim_data_cross[-testIndexes, ]
    pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~X75_to_100_VCO2Slope+X75_to_100_VO2Slope+VEvsVCO2Slope+MeanVE.VCO2, data=trainData, ntree=500, mtry=3, importance=TRUE,classwt=c(2000,20),keep.inbag=TRUE,replace=FALSE)
    prediction_for_table<-predict(rf_classifier,testData)
    table.conf <- table(observed=testData$PulmonaryLim,predicted=prediction_for_table)
    print(table.conf)
    ppv <-table.conf[2,2]/(table.conf[2,2]+table.conf[1,2])
    if (is.nan(ppv)){ppv=1}
    stvt <-table.conf[2,2]/(table.conf[2,2]+table.conf[2,1])
    spcft <-table.conf[1,1]/(table.conf[1,1]+table.conf[1,2])
    accrcy <- (table.conf[1,1]+table.conf[2,2])/(table.conf[1,1]+table.conf[1,2]+table.conf[2,2]+table.conf[2,1])
    positive.predictive.value <- append(positive.predictive.value, ppv)
    sensitivity.val <- append(sensitivity.val,stvt)
    specificity.val <- append(specificity.val,spcft)
    accuracy.val <- append(accuracy.val,accrcy)
    prediction_for_roc_curve <- predict(rf_classifier,testData,type="prob")
    PRROC_obj <- PRROC::roc.curve(scores.class0 = prediction_for_roc_curve[,2], weights.class0=testData$PulmonaryLim,
                       curve=TRUE)
    roc.vals <- append(roc.vals, PRROC_obj$auc)
}
print('Positive Predictive Value')
print(mean(positive.predictive.value))
print(sd(positive.predictive.value))
print('Sensitivity')
print(mean(sensitivity.val))
print(sd(sensitivity.val))
print('Specificity')
print(mean(specificity.val))
print(sd(specificity.val))
print('Accuracy')
print(mean(accuracy.val))
print(sd(accuracy.val))
print('AUC')
print(mean(roc.vals))
print(sd(roc.vals))
```

```{r}
library(ROCR)
prediction_for_roc_curve <- predict(pulm_rf_classifier,test_data,type="prob")
library(precrec)
precrec_obj <- evalmod(scores = prediction_for_roc_curve[,2], labels = pulm_test_data$PulmonaryLim)
autoplot(precrec_obj)
library(PRROC)

PRROC_obj <- roc.curve(scores.class0 = prediction_for_roc_curve[,2], weights.class0=pulm_test_data$PulmonaryLim,
                       curve=TRUE)
plot(PRROC_obj)

```


```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```

```{r cars}
#Randomly shuffle the data
pulmonary_lim_data_cross <- pulmonary_lim_data
pulmonary_lim_data_cross<-pulmonary_lim_data_cross[sample(nrow(pulmonary_lim_data_cross)),]

#Create 10 equally size folds
folds <- cut(seq(1,nrow(pulmonary_lim_data_cross)),breaks=5,labels=FALSE)
positive.predictive.value <- rep()
sensitivity.val <- rep()
specificity.val <- rep()
accuracy.val <- rep()
roc.vals <- rep()
#Perform 10 fold cross validation
for(i in 1:5){
    #Segement your data by fold using the which() function 
    testIndexes <- which(folds==i,arr.ind=TRUE)
    testData <- pulmonary_lim_data_cross[testIndexes, ]
    trainData <- pulmonary_lim_data_cross[-testIndexes, ]
#    rf_classifier = randomForest(as.factor(PulmonaryLim) ~ MeanHeartRate+MeanVE.VCO2+DiffPeakVO2+PeakVE+MeanVO2+VEvsVCO2Slope+MeanO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75O2Slope+MeanVCO2, data=trainData, ntree=500, mtry=10, importance=TRUE,classwt=c(20,1000),keep.inbag=TRUE,replace=FALSE)
    pulm_rf_classifier = randomForest(as.factor(PulmonaryLim) ~X75_to_100_VCO2Slope+X75_to_100_VO2Slope+VEvsVCO2Slope+MeanVE.VCO2	+X75_to_100_VESlope+X75_to_100_O2Slope+X75_to_100_HRSlope+MeanHeartRate+DiffPeakVO2+X75_to_100_RRSlope+X15_to_85_VEVO2Slope+MeanVO2+LowestVE+PeakHeartRate+MeanO2Pulse, data=trainData, ntree=500, mtry=3, importance=TRUE,classwt=c(20,20),keep.inbag=TRUE,replace=FALSE)
    #rf_classifier = randomForest(as.factor(PulmonaryLim) ~ X75VCO2Slope+X75VO2Slope+VEvsVCO2Slope+MeanVE.VCO2	+X75VESlope+X75O2Slope+MeanHeartRate+X75HRSlope+DiffPeakVO2+LowestVE+MeanVCO2, data=trainData, ntree=500, mtry=4, importance=TRUE,classwt=c(10,400000),keep.inbag=TRUE,replace=FALSE)
    prediction_for_table<-predict(rf_classifier,testData)
    table.conf <- table(observed=testData$PulmonaryLim,predicted=prediction_for_table)
    print(table.conf)
    ppv <-table.conf[2,2]/(table.conf[2,2]+table.conf[1,2])
    if (is.nan(ppv)){ppv=1}
    stvt <-table.conf[2,2]/(table.conf[2,2]+table.conf[2,1])
    spcft <-table.conf[1,1]/(table.conf[1,1]+table.conf[1,2])
    accrcy <- (table.conf[1,1]+table.conf[2,2])/(table.conf[1,1]+table.conf[1,2]+table.conf[2,2]+table.conf[2,1])
    positive.predictive.value <- append(positive.predictive.value, ppv)
    sensitivity.val <- append(sensitivity.val,stvt)
    specificity.val <- append(specificity.val,spcft)
    accuracy.val <- append(accuracy.val,accrcy)
    prediction_for_roc_curve <- predict(rf_classifier,testData,type="prob")
    PRROC_obj <- PRROC::roc.curve(scores.class0 = prediction_for_roc_curve[,2], weights.class0=testData$PulmonaryLim,
                       curve=TRUE)
    roc.vals <- append(roc.vals, PRROC_obj$auc)
}
print('Positive Predictive Value')
print(mean(positive.predictive.value))
print(sd(positive.predictive.value))
print('Sensitivity')
print(mean(sensitivity.val))
print(sd(sensitivity.val))
print('Specificity')
print(mean(specificity.val))
print(sd(specificity.val))
print('Accuracy')
print(mean(accuracy.val))
print(sd(accuracy.val))
print('AUC')
print(mean(roc.vals))
print(sd(roc.vals))
```


Variable importance
```{r}
varImpPlot(rf_classifier)
```

## Multiclass model

```{r}
other_lim_data <-dat2 %>% select(-c(CardiacLim,PulmonaryLim,Healthy))
sample_size = floor(0.8*nrow(other_lim_data))
set.seed(2345)
picked = sample(seq_len(nrow(other_lim_data)),size = sample_size)
train_data =other_lim_data[picked,]
test_data =other_lim_data[-picked,]
```

Using boruta for feature selection FOR THE CARDIAC LIMITATION
```{r}
boruta.train <- Boruta(MuscleSkeletalLim~., data = other_lim_data, doTrace = 2)
```

```{r}
plot(boruta.train, xlab = "", xaxt = "n")
lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i)
boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
names(lz) <- colnames(boruta.train$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train$ImpHistory), cex.axis = 0.5)
```

```{r}
boruta.df <- attStats(boruta.train)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```

```{r}
final.boruta <- TentativeRoughFix(boruta.train)
print(final.boruta)
getSelectedAttributes(final.boruta, withTentative = F)
```


```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```


## Muscle Skeletal Limitation Model


Selecting the pulmonary limitation data with the random split
```{r}
ms_lim_data <-dat2 %>% select(-c(CardiacLim,PulmonaryLim))
sample_size = floor(0.8*nrow(ms_lim_data))
set.seed(2345)
picked = sample(seq_len(nrow(ms_lim_data)),size = sample_size)
ms_train_data =ms_lim_data[picked,]
ms_test_data =ms_lim_data[-picked,]
```

Using boruta for feature selection FOR THE MUSCLE SKELETAL LIMITATION
```{r}
boruta.train <- Boruta(as.factor(Condition)~., data = ms_lim_data, doTrace = 2)
```


```{r}
plot(boruta.train, xlab = "", xaxt = "n")
lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i)
boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
names(lz) <- colnames(boruta.train$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train$ImpHistory), cex.axis = 0.5)
```
```{r}
boruta.df <- attStats(boruta.train)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```

now that we have the selected features, let's use random forest
```{r}
#train_data =cardiac_lim_data[picked,]
#test_data =cardiac_lim_data[-picked,]
selected.attributes <- getSelectedAttributes(final.boruta, withTentative = F)
main_rf_classifier = randomForest(as.factor(MuscleSkeletalLim) ~ X75HRSlope+X75VO2Slope+LowestRER+PeakRER	+PeakVE+LowestVE+LowestVCO2+PeakVCO2+StdO2Pulse+X75VCO2Slope+PeakRR+MeanVCO2+LowestRR+MinHeartRate+PeakHeartRate+MeanRER+X75VESlope+MeanVE+PeakVO2+MeanO2Pulse+PeakVO2Real+LowestVO2+DiffPeakVO2+MeanVO2+MeanHeartRate, data=ms_train_data, ntree=500, mtry=2, importance=TRUE,classwt=c(40,100), keep.inbag=TRUE,replace=FALSE)
print(main_rf_classifier)
```

On the test dataset
```{r}
prediction_for_table<-predict(main_rf_classifier,ms_test_data)
table(observed=ms_test_data$MuscleSkeletalLim,predicted=prediction_for_table)
```
```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision != 'Rejected') %>% arrange(desc(meanImp))

```



Doing the test with the new dataset

Load the data 
```{r}
source_CPET_2 <- read.csv("C:/Users/julio/Projects/HealthInformatics/health-informatics-capstone/jp-post-capstone/DigitalDataEnriched_updated.csv", header=TRUE, sep=",")
source_CPET_2 <-source_CPET_2 %>% select(-c(X, PatientId,SessionId , sex, age,BMI))
names(source_CPET_2)
```
Finding more data
Scaling the data
```{r}
source_CPET_2$PrimaryCondition <- source_CPET_2$PrimaryCardiacLim*4 + source_CPET_2$PrimaryPulmonaryLim*3 + source_CPET_2$OtherPrimaryLim*2+source_CPET_2$Healthy
source_CPET_2$PrimaryCondition <- as.factor(source_CPET_2$PrimaryCondition)
#dat2 <- source_CPET %>% mutate_at(-c("CardiacLim ", "PulmonaryLim","MuscleSkeletalLim"), ~(scale(.) %>% as.vector))
data_scaled <- source_CPET_2 %>% mutate_at(c("MaxVO2_EST","PeakHeartRate","MeanHeartRate","MinHeartRate","StdHeartRate","LowestVE.VCO2","PeakVE.VCO2","MeanVE.VCO2","StdVE.VCO2","PeakVO2Real","DiffPeakVO2","MeanRER","PeakRER","LowestRER","MeanVE","PeakVE","LowestVE","MeanRR","PeakRR","LowestRR","MeanVO2","PeakVO2","LowestVO2","HRvsVO2Slope","VEvsVCO2Slope","MeanO2Pulse","MaxO2Pulse","MinO2Pulse","StdO2Pulse","X75VO2Slope","X75HRSlope","X75VCO2Slope","X75VESlope","X75RERSlope","X75RRSlope","X75O2Slope","VO2atVT","VO2vsPeakVO2atVT","MeanVCO2","PeakVCO2","LowestVCO2"), ~(scale(.) %>% as.vector))
```
Selecting the cardiac limitation data with the random split
```{r}
lim_data <-data_scaled %>% select(-c(PrimaryPulmonaryLim,PrimaryCardiacLim,OtherPrimaryLim,Healthy))
sample_size = floor(0.8*nrow(lim_data))
set.seed(2345)
picked = sample(seq_len(nrow(lim_data)),size = sample_size)
train_data =lim_data[picked,]
test_data =lim_data[-picked,]
```

Using boruta in a single multilabel category
```{r}
boruta.train <- Boruta(PrimaryCondition~., data = train_data, doTrace = 2)
```

```{r}
boruta.train
```

```{r}
plot(boruta.train, xlab = "", xaxt = "n", type='l')
lz<-lapply(1:ncol(boruta.train$ImpHistory),function(i)
boruta.train$ImpHistory[is.finite(boruta.train$ImpHistory[,i]),i])
names(lz) <- colnames(boruta.train$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta.train$ImpHistory), cex.axis = 0.5)
#text(cex = 0.9)
#text(x = 1:length(boruta.train), y = par("usr")[3] - 2.5, labels = names(Labels), srt = 35, cex = 0.8, xpd = NA)
```

Picking tentative features into important features
```{r}
final.boruta <- TentativeRoughFix(boruta.train)
print(final.boruta)
getSelectedAttributes(final.boruta, withTentative = F)
```


```{r}
boruta.df <- attStats(final.boruta)
class(boruta.df)
print(boruta.df)
#starwars %>% filter(mass > mean(mass, na.rm = TRUE))
boruta.df %>% filter(decision == 'Rejected') %>% arrange(desc(meanImp))

```

```{r}
cond_rf_classifier = randomForest(PrimaryCondition ~. -MeanVE-LowestRER-PeakVE.VCO2-PeakRER-MinO2Pulse-MeanRR-VO2vsPeakVO2atVT-MaxVO2_EST-HRvsVO2Slope-HRvsVO2Slope-HasAnaerobicThresholdMean-Observation	, data=train_data, ntree=500, mtry=2, importance=TRUE,keep.inbag=TRUE,replace=FALSE)
prediction_for_table<-predict(cond_rf_classifier,test_data)
table(observed=test_data$PrimaryCondition,predicted=prediction_for_table)
```



```{r}
library(MASS)
# Fit the model
train_data$PrimaryCondition <- train_data$PrimaryCondition +1

model <- lda(PrimaryCondition~MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope  , data = train_data)
# Make predictions
predictions <- model %>% predict(test_data)
# Model accuracy
mean(predictions$class==test_data$PrimaryCondition)
```

```{r}
library(MASS)
model <- lda(PrimaryCondition~~MeanHeartRate+PeakVO2Real+DiffPeakVO2+PeakRER+MeanVO2+PeakVO2+LowestVO2+HRvsVO2Slope+MeanO2Pulse+StdO2Pulse+X75VO2Slope+X75HRSlope+X75VCO2Slope+X75VESlope+X75RERSlope+X75RRSlope+X75O2Slope , data = train_data)
model
```






